// Prisma schema for SIGES database
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum EstadoCivil {
  SOLTERO
  CASADO
  DIVORCIADO
  VIUDO
  CONVIVIENTE
}

enum EstadoFicha {
  INCOMPLETA
  COMPLETA
  EN_REVISION
  APROBADA
  RECHAZADA
}

enum EstadoRegistro {
  BORRADOR
  EN_PROCESO
  COMPLETADO
  APROBADO
}

enum Sexo {
  M
  F
}

// Audit model
model Auditoria {
  id              String    @id @default(uuid())
  accion          String
  recurso         String
  id_recurso      String
  id_usuario      String
  ip              String?
  user_agent      String?
  datos_sensibles Json?
  estado          String    @default("EXITOSO") // EXITOSO, FALLIDO
  fecha           DateTime  @default(now())

  usuario Usuario @relation(fields: [id_usuario], references: [id])

  @@map("auditorias")
}

// Rate limiting model
model RateLimit {
  id     String   @id @default(uuid())
  clave  String
  fecha  DateTime @default(now())

  @@unique([clave, fecha])
  @@map("rate_limits")
}

// Users
model Usuario {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  nombres           String
  apellidos         String
  dni               String?   @unique
  telefono          String?
  activo            Boolean   @default(true)
  email_verificado  Boolean   @default(false)
  ultimo_login      DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  rol_id            String
  rol               Rol       @relation(fields: [rol_id], references: [id])

  fichas_sociales_creadas     FichaSocial[]      @relation("FichaCreador")
  fichas_sociales_actualizadas FichaSocial[]    @relation("FichaActualizador")
  entrevistas_creadas          EntrevistaAplicada[] @relation("EntrevistaCreador")
  entrevistas_actualizadas     EntrevistaAplicada[] @relation("EntrevistaActualizador")
  estudiantes_creados          Estudiante[]       @relation("EstudianteCreador")
  estudiantes_actualizados     Estudiante[]       @relation("EstudianteActualizador")
  informes_sociales_creados    InformeSocial[]    @relation("InformeSocialCreador")
  informes_sociales_actualizados InformeSocial[] @relation("InformeSocialActualizador")
  registros_entrevistas_creados    RegistroEntrevista[] @relation("RegistroEntrevistaCreador")
  registros_entrevistas_actualizados RegistroEntrevista[] @relation("RegistroEntrevistaActualizador")
  registros_visitas_creados     RegistroVisitaDomiciliaria[] @relation("RegistroVisitaCreador")
  registros_visitas_actualizados RegistroVisitaDomiciliaria[] @relation("RegistroVisitaActualizador")
  informes_visitas_creados      InformeVisitaDomiciliaria[] @relation("InformeVisitaCreador")
  informes_visitas_actualizados InformeVisitaDomiciliaria[] @relation("InformeVisitaActualizador")
  cronicas_creadas              CronicaCasoSocial[] @relation("CronicaCasoCreador")
  cronicas_actualizadas         CronicaCasoSocial[] @relation("CronicaCasoActualizador")
  situaciones_socio_familiares_creadas SituacionSocioFamiliar[] @relation("SituacionSocioFamiliarCreador")
  situaciones_socio_familiares_actualizadas SituacionSocioFamiliar[] @relation("SituacionSocioFamiliarActualizador")
  auditorias                  Auditoria[]

  @@map("usuarios")
}

// Roles
model Rol {
  id          String   @id @default(uuid())
  nombre      String   @unique
  descripcion String?
  es_sistema  Boolean  @default(false)
  activo      Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  usuarios    Usuario[]
  modulos     RolModulo[]

  @@map("roles")
}

// Modules
model Modulo {
  id          String   @id @default(uuid())
  nombre      String   @unique
  codigo      String   @unique
  descripcion String?
  activo      Boolean  @default(true)
  created_at  DateTime @default(now())

  roles       RolModulo[]

  @@map("modulos")
}

// Role-Module relationship
model RolModulo {
  id       String @id @default(uuid())
  rol_id   String
  modulo_id String

  rol    Rol    @relation(fields: [rol_id], references: [id], onDelete: Cascade)
  modulo Modulo @relation(fields: [modulo_id], references: [id], onDelete: Cascade)

  @@unique([rol_id, modulo_id])
  @@map("roles_modulos")
}

// Ficha Social
model FichaSocial {
  id                   String      @id @default(uuid())
  estudiante_id        String?     // Nueva relación opcional con Estudiante
  apellidos            String
  nombres              String
  sexo                 Sexo?
  nacionalidad         String?
  fecha_nacimiento     DateTime
  dni                  String?     @unique
  carne_extranjeria    String?
  nivel_educativo      String?
  estado_civil         EstadoCivil?
  num_hijos            Int         @default(0)
  domicilio_actual     String?
  distrito             String?

  // JSON fields for complex data
  datos_vivienda       Json        @default("{\"material\": [], \"tenencia\": [], \"servicios\": [], \"ubicacion\": [], \"problemas_sociales\": []}")
  datos_salud          Json        @default("{\"alergias\": {}, \"enfermedades\": {}, \"medicamentos\": [], \"grupo_sanguineo\": null}")
  datos_economicos     Json        @default("{\"egresos\": {\"deudas_seguros\": {}, \"gastos_familiares\": {}, \"servicios_basicos\": {}}, \"ingresos\": {\"otros\": 0, \"conyuge\": 0, \"trabajador\": 0}}")
  composicion_familiar Json        @default("{\"padre\": null, \"madre\": null}")
  declaracion_jurada   Json        @default("{\"fecha_firma\": null, \"firma_digital\": null, \"acepta_terminos\": false, \"nombre_firmante\": null}")

  estado               EstadoFicha @default(INCOMPLETA)
  porcentaje_completado Int         @default(0)

  created_by           String?
  updated_by           String?
  created_at           DateTime    @default(now())
  updated_at           DateTime    @updatedAt

  creador              Usuario?            @relation("FichaCreador", fields: [created_by], references: [id])
  actualizador         Usuario?            @relation("FichaActualizador", fields: [updated_by], references: [id])
  estudiante           Estudiante?         @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  entrevistas          EntrevistaAplicada[]

  @@index([apellidos])
  @@index([nombres])
  @@index([dni])
  @@index([estado])
  @@index([distrito])
  @@index([created_at])
  @@index([estudiante_id])  // Nuevo índice
  @@map("fichas_sociales")
}

// Entrevista Aplicada
model EntrevistaAplicada {
  id                     String      @id @default(uuid())
  ficha_social_id        String?
  estudiante_id          String?     // Nueva relación opcional con Estudiante
  estudiante_nombres     String      // Mantener por compatibilidad con datos existentes
  estudiante_apellidos   String
  estudiante_edad        Int?
  estudiante_fecha_nacimiento DateTime?
  aula                   String?
  grado                  String?

  // JSON field for answers
  respuestas             Json        @default("{\"pregunta_1\": \"\", \"pregunta_3\": \"\", \"pregunta_4\": \"\", \"pregunta_5\": \"\", \"pregunta_6\": \"\", \"pregunta_7\": \"\", \"pregunta_8\": \"\", \"pregunta_9\": \"\", \"pregunta_10\": \"\", \"pregunta_2_opcion\": \"\", \"pregunta_2_porque\": \"\"}")

  estado                 EstadoFicha @default(INCOMPLETA)
  porcentaje_completado  Int         @default(0)

  created_by             String?
  updated_by             String?
  created_at             DateTime    @default(now())
  updated_at             DateTime    @updatedAt

  ficha_social           FichaSocial? @relation(fields: [ficha_social_id], references: [id], onDelete: SetNull)
  estudiante             Estudiante?  @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  creador                Usuario?     @relation("EntrevistaCreador", fields: [created_by], references: [id])
  actualizador           Usuario?     @relation("EntrevistaActualizador", fields: [updated_by], references: [id])

  @@index([estudiante_apellidos, estudiante_nombres])
  @@index([ficha_social_id])
  @@index([estudiante_id])  // Nuevo índice
  @@index([estado])
  @@index([grado])
  @@index([created_at])
  @@map("entrevistas_aplicadas")
}

// Estudiante
model Estudiante {
  id                String    @id @default(uuid())
  codigo            String    @unique
  apellido_paterno  String
  apellido_materno  String
  nombres           String
  fecha_nacimiento  DateTime?
  dni               String?   @unique
  telefono          String?
  email             String?
  direccion         String?
  activo            Boolean   @default(true)

  created_by        String?
  updated_by        String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  creador           Usuario?               @relation("EstudianteCreador", fields: [created_by], references: [id])
  actualizador      Usuario?               @relation("EstudianteActualizador", fields: [updated_by], references: [id])
  entrevistas        EntrevistaAplicada[]   // Relación inversa con EntrevistaAplicada
  fichas_sociales   FichaSocial[]          // Relación inversa con FichaSocial
  informes_sociales  InformeSocial[]        // Relación inversa con InformeSocial
  registros_entrevistas RegistroEntrevista[] // Relación inversa con RegistroEntrevista
  registros_visitas  RegistroVisitaDomiciliaria[] // Relación inversa con RegistroVisitaDomiciliaria
  informes_visitas   InformeVisitaDomiciliaria[] // Relación inversa con InformeVisitaDomiciliaria
  cronicas           CronicaCasoSocial[]    // Relación inversa con CronicaCasoSocial
  situaciones_socio_familiares SituacionSocioFamiliar[] // Relación inversa con SituacionSocioFamiliar

  @@index([codigo])
  @@index([apellido_paterno, apellido_materno])
  @@index([dni])
  @@index([activo])
  @@index([created_at])
  @@map("estudiantes")
}

// Informe Social
model InformeSocial {
  id                   String              @id @default(uuid())
  estudiante_id        String?

  // I. Datos generales
  nombres_apellidos    String?
  edad                 Int?
  estado_civil         String?
  grado_instruccion    String?
  direccion            String?
  motivo               String?

  // II. Situación familiar
  situacion_familiar   String?             @db.Text

  // III. Situación económica
  situacion_economica  String?             @db.Text

  // IV. Vivienda
  vivienda             String?             @db.Text

  // V. Educación
  educacion            String?             @db.Text

  // VI. Problema social
  problema_social      String?             @db.Text

  // VII. Apreciación profesional
  apreciacion_profesional String?
  lugar                String?
  fecha                DateTime?

  created_by           String?
  updated_by           String?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt

  estudiante           Estudiante?         @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  creador              Usuario?            @relation("InformeSocialCreador", fields: [created_by], references: [id])
  actualizador         Usuario?            @relation("InformeSocialActualizador", fields: [updated_by], references: [id])

  @@index([estudiante_id])
  @@index([created_at])
  @@map("informes_sociales")
}

// Registro de Entrevista
model RegistroEntrevista {
  id                   String              @id @default(uuid())
  estudiante_id        String?

  lugar                String?
  fecha                DateTime?
  hora                 String?
  tema                 String?
  objetivo             String?
  entrevistado         String?
  entrevistador        String?
  descripcion_relato   String?             @db.Text

  created_by           String?
  updated_by           String?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt

  estudiante           Estudiante?         @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  creador              Usuario?            @relation("RegistroEntrevistaCreador", fields: [created_by], references: [id])
  actualizador         Usuario?            @relation("RegistroEntrevistaActualizador", fields: [updated_by], references: [id])

  @@index([estudiante_id])
  @@index([fecha])
  @@map("registros_entrevistas")
}

// Registro de Visita Domiciliaria
model RegistroVisitaDomiciliaria {
  id                   String              @id @default(uuid())
  estudiante_id        String?

  // I. Datos generales
  nombre_entrevistado  String?
  domicilio            String?
  fecha_visita         DateTime?
  responsable          String?

  // II. Objetivo
  objetivo             String?             @db.Text

  // III. Relato
  relato               String?             @db.Text

  created_by           String?
  updated_by           String?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt

  estudiante           Estudiante?         @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  creador              Usuario?            @relation("RegistroVisitaCreador", fields: [created_by], references: [id])
  actualizador         Usuario?            @relation("RegistroVisitaActualizador", fields: [updated_by], references: [id])

  @@index([estudiante_id])
  @@index([fecha_visita])
  @@map("registros_visitas_domiciliarias")
}

// Informe de Visita Domiciliaria
model InformeVisitaDomiciliaria {
  id                   String              @id @default(uuid())
  estudiante_id        String?

  // I. Datos generales
  nombres_apellidos    String?
  direccion            String?
  motivo               String?

  // II. Objetivos
  objetivos            String?             @db.Text

  // III. Narración
  narracion            String?             @db.Text

  // IV. Conclusiones
  conclusiones         String?             @db.Text

  created_by           String?
  updated_by           String?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt

  estudiante           Estudiante?         @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  creador              Usuario?            @relation("InformeVisitaCreador", fields: [created_by], references: [id])
  actualizador         Usuario?            @relation("InformeVisitaActualizador", fields: [updated_by], references: [id])

  @@index([estudiante_id])
  @@index([created_at])
  @@map("informes_visitas_domiciliarias")
}

// Crónica de Caso Social
model CronicaCasoSocial {
  id                   String              @id @default(uuid())
  estudiante_id        String?

  // I. Datos generales
  num_reunion          Int?
  fecha_hora           DateTime?
  nombres_apellidos    String?
  asistentes           String?

  // II. Actividades realizadas
  actividades_realizadas String?           @db.Text

  // III. Programas
  programas            String?             @db.Text

  // IV. Relato
  relato               String?             @db.Text

  // V. Interpretación
  interpretacion       String?             @db.Text

  // VI. Sugerencias
  sugerencias          String?             @db.Text

  created_by           String?
  updated_by           String?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt

  estudiante           Estudiante?         @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  creador              Usuario?            @relation("CronicaCasoCreador", fields: [created_by], references: [id])
  actualizador         Usuario?            @relation("CronicaCasoActualizador", fields: [updated_by], references: [id])

  @@index([estudiante_id])
  @@index([fecha_hora])
  @@map("cronicas_casos_sociales")
}

// Situación Socio Familiar
model SituacionSocioFamiliar {
  id                   String              @id @default(uuid())
  estudiante_id        String?

  // INTERACCIÓN Y UNIDAD FAMILIAR
  subsistema_conyugal  String?             @db.Text
  subsistema_paterno_fiscal String?        @db.Text
  subsistema_fraternal String?             @db.Text
  solidaridad_familiar  String?            @db.Text
  relaciones           String?             @db.Text

  // DESEMPEÑO DE ROLES
  desempeno_roles      String?             @db.Text

  // RELACIONES DE CRIANZA
  relaciones_crianza   String?             @db.Text

  // RELACIONES CON EL EXOGRUPO
  relaciones_exogrupo  String?             @db.Text

  // PAUTAS DE VIDA FAMILIAR
  pautas_vida_familiar String?             @db.Text

  created_by           String?
  updated_by           String?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt

  estudiante           Estudiante?         @relation(fields: [estudiante_id], references: [id], onDelete: SetNull)
  creador              Usuario?            @relation("SituacionSocioFamiliarCreador", fields: [created_by], references: [id])
  actualizador         Usuario?            @relation("SituacionSocioFamiliarActualizador", fields: [updated_by], references: [id])

  @@index([estudiante_id])
  @@index([created_at])
  @@map("situaciones_socio_familiares")
}

